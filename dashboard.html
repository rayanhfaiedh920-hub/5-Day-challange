<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        .user-info, .invite-info, .admin-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .admin-section {
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Willkommen zum Dashboard</h1>
        <div class="user-info">
            <h2>Benutzerinformationen</h2>
            <p><strong>Name:</strong> <span id="fullName"></span></p>
            <p><strong>Email:</strong> <span id="email"></span></p>
            <p><strong>PayPal Email:</strong> <span id="paypalEmail"></span></p>
        </div>
        <div class="invite-info">
            <h2>Einladungsinformationen</h2>
            <p><strong>Dein Einladungscode:</strong> <span id="inviteCode"></span></p>
            <p><strong>Eingeladen von:</strong> <span id="invitedBy"></span></p>
            <p><strong>Anzahl deiner Einladungen:</strong> <span id="invitesCount"></span></p>
        </div>

        <!-- Admin Section -->
        <div class="admin-section" id="adminSection">
            <h2>Admin Bereich</h2>
            <div class="form-group">
                <label for="searchInviteCode">Nach Einladungscode suchen:</label>
                <input type="text" class="form-control" id="searchInviteCodeInput" placeholder="Einladungscode eingeben">
                <button class="btn btn-primary mt-2" onclick="searchInviteCode()">Suchen</button>
            </div>
            <div id="searchResults"></div>
        </div>

        <button onclick="logout()" class="btn btn-danger">Abmelden</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                // User is signed in.
                var db = firebase.firestore();
                db.collection("users").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        document.getElementById("fullName").textContent = userData.fullName;
                        document.getElementById("email").textContent = user.email;
                        document.getElementById("paypalEmail").textContent = userData.paypalEmail || 'Nicht angegeben';
                        document.getElementById("inviteCode").textContent = userData.inviteCode;
                        document.getElementById("invitedBy").textContent = userData.invitedBy || 'Niemand';
                        document.getElementById("invitesCount").textContent = userData.invitesCount || 0;

                        // Check if the logged-in user is the admin
                        if (user.email === "rayanhfaiedh920@gmail.com") {
                            document.getElementById("adminSection").style.display = "block";
                        }
                    } else {
                        console.log("No such document!");
                    }
                }).catch((error) => {
                    console.log("Error getting document:", error);
                });
            } else {
                // No user is signed in.
                window.location.href = "index.html";
            }
        });

        function logout() {
            firebase.auth().signOut().then(() => {
                // Sign-out successful.
                window.location.href = "index.html";
            }).catch((error) => {
                // An error happened.
                console.error("Logout Error", error);
            });
        }

        function searchInviteCode() {
            const searchCode = document.getElementById("searchInviteCodeInput").value.trim();
            if (!searchCode) {
                alert("Bitte geben Sie einen Einladungscode ein.");
                return;
            }

            const db = firebase.firestore();
            const resultsDiv = document.getElementById("searchResults");
            resultsDiv.innerHTML = 'Suche...';

            db.collection("users").where("inviteCode", "==", searchCode).get()
            .then((querySnapshot) => {
                if (querySnapshot.empty) {
                    resultsDiv.innerHTML = "Kein Benutzer mit diesem Einladungscode gefunden.";
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const searchedUserData = doc.data();
                    const searchedUserUid = doc.id;

                    // Now find the referrer of the searched user
                    const referrerInviteCode = searchedUserData.invitedBy;
                    if (!referrerInviteCode || referrerInviteCode === 'Niemand') {
                         resultsDiv.innerHTML = `
                            <h4>Suchergebnisse für Code: ${searchCode}</h4>
                            <p><strong>Benutzer-ID:</strong> ${searchedUserUid}</p>
                            <p><strong>Vollständiger Name:</strong> ${searchedUserData.fullName}</p>
                            <p><strong>Registrierte Email:</strong> ${searchedUserData.email}</p>
                            <p>Dieser Benutzer wurde von niemandem eingeladen.</p>
                         `;
                         return;
                    }

                    db.collection("users").where("inviteCode", "==", referrerInviteCode).get()
                    .then(referrerSnapshot => {
                        if (referrerSnapshot.empty) {
                            resultsDiv.innerHTML = "Fehler: Referrer nicht gefunden.";
                            return;
                        }
                        referrerSnapshot.forEach(referrerDoc => {
                            const referrerData = referrerDoc.data();
                            const lastProvisionDate = searchedUserData.lastProvisionDate || 'Nicht festgelegt';

                            resultsDiv.innerHTML = `
                                <h4>Benutzer gefunden mit Code: ${searchCode}</h4>
                                <p><strong>Vollständiger Name:</strong> ${searchedUserData.fullName}</p>
                                <p><strong>Registrierte Email:</strong> ${searchedUserData.email}</p>
                                <hr>
                                <h4>Geworben von:</h4>
                                <p><strong>Vollständiger Name des Werbers:</strong> ${referrerData.fullName}</p>
                                <p><strong>Registrierte Email des Werbers:</strong> ${referrerData.email}</p>
                                <p><strong>PayPal Email des Werbers:</strong> ${referrerData.paypalEmail || 'Nicht angegeben'}</p>
                                <hr>
                                <h4>Provision-Status</h4>
                                <p><strong>Letzte Provisionszahlung am:</strong> <span id="lastProvisionDate-${searchedUserUid}">${lastProvisionDate}</span></p>
                                <div class="form-group">
                                    <label for="provisionDateInput-${searchedUserUid}">Datum der Provisionszahlung aktualisieren:</label>
                                    <input type="date" class="form-control" id="provisionDateInput-${searchedUserUid}">
                                    <button class="btn btn-success mt-2" onclick="updateProvisionDate('${searchedUserUid}')">Aktualisieren</button>
                                </div>
                            `;
                        });
                    });
                });
            })
            .catch((error) => {
                console.error("Error searching for invite code: ", error);
                resultsDiv.innerHTML = "Ein Fehler ist bei der Suche aufgetreten.";
            });
        }

        function updateProvisionDate(userId) {
            const newDate = document.getElementById(`provisionDateInput-${userId}`).value;
            if (!newDate) {
                alert("Bitte wählen Sie ein Datum aus.");
                return;
            }

            const db = firebase.firestore();
            db.collection("users").doc(userId).update({
                lastProvisionDate: newDate
            })
            .then(() => {
                alert("Datum der Provisionszahlung erfolgreich aktualisiert!");
                document.getElementById(`lastProvisionDate-${userId}`).textContent = newDate;
            })
            .catch((error) => {
                console.error("Error updating provision date: ", error);
                alert("Fehler beim Aktualisieren des Datums.");
            });
        }

    </script>
</body>
</html>

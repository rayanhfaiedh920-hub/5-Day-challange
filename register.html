<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syndicate | Create Account</title>
    <style>
        :root {
            --apple-blue: #0071e3;
            --bg-light: #f5f5f7;
            --text-main: #1d1d1f;
            --text-sub: #86868b;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background-color: var(--bg-light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-main);
        }

        .register-card {
            background: white;
            padding: 40px;
            border-radius: 30px;
            width: 100%;
            max-width: 440px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.04);
            text-align: center;
            box-sizing: border-box;
        }

        h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
        p.subtitle { color: var(--text-sub); margin-bottom: 25px; font-size: 16px; }

        .name-row { display: flex; gap: 12px; margin-bottom: 12px; }
        .input-group { text-align: left; margin-bottom: 12px; position: relative; }

        label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-sub);
            text-transform: uppercase;
            margin-left: 5px;
            margin-bottom: 5px;
            display: block;
        }

        input {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid #d2d2d7;
            background-color: #f5f5f7;
            font-size: 15px;
            box-sizing: border-box;
            outline: none;
            transition: 0.2s;
        }

        input:focus { border-color: var(--apple-blue); background-color: white; }

        button {
            width: 100%;
            padding: 16px;
            background-color: var(--apple-blue);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
        }

        .footer { margin-top: 20px; color: var(--text-sub); font-size: 13px; }
        .footer a { color: var(--apple-blue); text-decoration: none; font-weight: 500; }

        #togglePassword {
            position: absolute;
            right: 15px;
            top: 38px; /* Angepasst an die Label-H√∂he */
            cursor: pointer;
            font-size: 18px;
            user-select: none;
        }
    </style>
</head>
<body>

    <div class="register-card">
        <h1>Create Account</h1>
        <p class="subtitle">Join the Syndicate Protocol.</p>

        <div class="name-row">
            <input type="text" id="fName" placeholder="First Name">
            <input type="text" id="lName" placeholder="Last Name">
        </div>

        <div class="input-group">
            <label>PayPal Email (for commissions)</label>
            <input type="email" id="paypalEmail" placeholder="paypal@example.com">
        </div>

        <div class="input-group">
            <label>Invite Code</label>
            <input type="text" id="usedCodeInput" placeholder="E.G. RAYAN2025">
        </div>

        <div class="input-group">
            <label>Email Address</label>
            <input type="email" id="email" placeholder="email@example.com">
        </div>

        <div class="input-group">
            <label>Password</label>
            <input type="password" id="pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <span id="togglePassword">üëÅÔ∏è</span>
        </div>

        <button onclick="handleRegister()">Complete Registration</button>

        <div class="footer">
            Already have an account? <a href="login.html">Login here</a>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAYO0J1GWXIowL0c2mu4x8h6k5R6BVG26U",
        authDomain: "syndicate-protocol-48f8c.firebaseapp.com",
        projectId: "syndicate-protocol-48f8c",
        storageBucket: "syndicate-protocol-48f8c.firebasestorage.app",
        messagingSenderId: "47535029358",
        appId: "1:47535029358:web:9990ca7fad4f0ed72bba7f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- NEU: SICHERHEITS-CHECK ---
    const urlParams = new URLSearchParams(window.location.search);
    const hasPaid = urlParams.get('pay');

    // Wenn der Parameter "pay=success" fehlt, sperren wir die Seite
    if (hasPaid !== 'success') {
        alert("Access Denied: Please complete the payment first.");
        window.location.replace("info.html"); 
    }
    // ------------------------------

    // Passwort-Auge Logik
    const togglePassword = document.querySelector('#togglePassword');
    const passwordInput = document.querySelector('#pass');

    if(togglePassword && passwordInput) {
        togglePassword.addEventListener('click', () => {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            togglePassword.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
        });
    }

    // URL Ref-Code Logik (f√ºr Einladungen)
    const codeFromUrl = urlParams.get('ref');
    if (codeFromUrl) {
        const refInput = document.getElementById('usedCodeInput');
        if(refInput) refInput.value = codeFromUrl;
    }

    window.handleRegister = async () => {
        const firstName = document.getElementById('fName').value.trim();
        const lastName = document.getElementById('lName').value.trim();
        const paypal = document.getElementById('paypalEmail').value.trim();
        const email = document.getElementById('email').value.trim();
        const pass = document.getElementById('pass').value;
        const refCode = document.getElementById('usedCodeInput').value.trim() || "DIRECT";

        if(!firstName || !lastName || !paypal || !email || !pass) {
            alert("Please fill in all fields.");
            return;
        }

        let user;
        try {
            const userCred = await createUserWithEmailAndPassword(auth, email, pass);
            user = userCred.user;
        } catch (e) {
            if (e.code === 'auth/email-already-in-use') {
                try {
                    const userCred = await signInWithEmailAndPassword(auth, email, pass);
                    user = userCred.user;
                } catch (loginError) {
                    alert("Email already in use. Please check your password or use another email.");
                    return;
                }
            } else {
                alert("Error: " + e.message);
                return;
            }
        }

        try {
            const myCode = firstName.toUpperCase() + Math.floor(Math.random() * 1000);
            await setDoc(doc(db, "members", user.uid), {
                displayName: firstName + " " + lastName,
                firstName: firstName,
                email: email,
                paypalEmail: paypal,
                myInviteCode: myCode,      
                referredBy: refCode,       
                balance: 0,
                paymentStatus: "learning_phase", 
                joined: new Date().toISOString()
            });

            alert("Registration successful!");
            window.location.href = "dashboard.html";
        } catch (dbError) {
            alert("Database Error: " + dbError.message);
        }
    };
</script>
</body>
</html>
